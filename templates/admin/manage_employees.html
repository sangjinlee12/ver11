{% extends "base_gov.html" %}

{% block title %}에스에스전력 - 직원 관리{% endblock %}

{% block content %}
<div class="gov-breadcrumb">
    <a href="{{ url_for('main.dashboard') }}">홈</a>
    <i class="fas fa-chevron-right"></i>
    <span>직원 관리</span>
</div>

<div class="gov-page-header">
    <h1 class="gov-page-title">
        <i class="fas fa-users"></i> 직원 관리
    </h1>
    <p class="gov-page-subtitle">직원 정보와 휴가 현황을 등록하고 관리합니다.</p>
</div>

<!-- 성공 메시지 -->
{% if get_flashed_messages() %}
    <div class="gov-alert gov-alert-success" style="margin-bottom: 20px;">
        <i class="fas fa-check-circle"></i>
        {% for message in get_flashed_messages() %}
            {{ message }}
        {% endfor %}
    </div>
{% endif %}

<!-- 직원 대량 등록 -->
<div class="gov-card" style="margin-bottom: 25px;">
    <div class="gov-card-header">
        <i class="fas fa-upload"></i> 직원 대량 등록
        <small style="margin-left: 10px; color: #6c757d;">엑셀 파일로 여러 직원을 한 번에 등록합니다</small>
    </div>
    <div class="gov-card-body">
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;">
            <div>
                <form action="{{ url_for('admin.upload_employees') }}" method="post" enctype="multipart/form-data">
                    {{ upload_form.hidden_tag() }}
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label class="gov-form-label">{{ upload_form.file.label }}</label>
                            {{ upload_form.file(class="gov-form-control", accept=".xlsx,.xls") }}
                            {% if upload_form.file.errors %}
                                <div style="color: #dc3545; font-size: 12px; margin-top: 5px;">
                                    {% for error in upload_form.file.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            {{ upload_form.submit(class="gov-btn gov-btn-primary") }}
                        </div>
                    </div>
                </form>
                
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #495057;">엑셀 파일 형식 안내</h4>
                    <div style="font-size: 12px; color: #6c757d; line-height: 1.4;">
                        <p>• <strong>필수 항목</strong>: username(아이디), name(이름), password(비밀번호), email(이메일), department(부서), position(직급)</p>
                        <p>• <strong>선택 항목</strong>: hire_date(입사일, YYYY-MM-DD 형식)</p>
                        <p>• 샘플 파일을 다운로드하여 정확한 형식을 확인하세요.</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-rows: auto auto; gap: 15px; justify-items: center; align-content: start; min-width: 200px;">
                <a href="{{ url_for('admin.download_employee_template') }}" class="gov-btn" style="background: #6c757d; color: white; width: 100%; text-align: center; height: 38px; line-height: 38px; text-decoration: none;">
                    <i class="fas fa-download" style="margin-right: 6px;"></i>샘플 파일 다운로드
                </a>
                <a href="{{ url_for('admin.add_employee') }}" class="gov-btn gov-btn-success" style="width: 100%; text-align: center; height: 38px; line-height: 38px; text-decoration: none;">
                    <i class="fas fa-user-plus" style="margin-right: 6px;"></i>직원 등록
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 직원 목록 -->
<div class="gov-card">
    <div class="gov-card-header">
        <i class="fas fa-list"></i> 직원 목록
        <small style="margin-left: 10px; color: #6c757d;">전체 직원과 휴가 현황을 관리합니다</small>
    </div>
        
    <div class="gov-card-body">
        {% if employees %}
            <table class="gov-table">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>부서</th>
                        <th>직급</th>
                        <th>이메일</th>
                        <th>입사일</th>
                        <th>남은 휴가</th>
                        <th>사용 휴가</th>
                        <th>액션</th>
                        </tr>
                    </thead>
                <tbody>
                    {% for employee in employees %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #003d82, #002855); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                    {{ employee.name[0] }}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #212529;">{{ employee.name }}</div>
                                    <div style="font-size: 12px; color: #6c757d;">{{ employee.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ employee.department or '-' }}</td>
                        <td>{{ employee.position or '-' }}</td>
                        <td>{{ employee.email }}</td>
                        <td>
                            {% if employee.hire_date %}
                                {{ employee.hire_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                <span style="color: #f39c12;">미설정</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if employee.remaining_vacation_days is defined %}
                                <strong style="color: #00b894;">{{ employee.remaining_vacation_days }}일</strong>
                            {% else %}
                                <span style="color: #f39c12;">미설정</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if employee.current_vacation_days %}
                                <span style="color: #636e72;">{{ employee.current_vacation_days.used_days }}일</span>
                            {% else %}
                                <span style="color: #f39c12;">0일</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <a href="{{ url_for('admin.set_vacation_days', user_id=employee.id, year=current_year) }}" 
                                   class="gov-btn gov-btn-primary" style="font-size: 11px; padding: 4px 8px;">
                                    <i class="fas fa-cog"></i> 휴가 설정
                                </a>
                                <a href="{{ url_for('admin.employee_vacation_report', user_id=employee.id) }}" 
                                   class="gov-btn" style="background: #6c5ce7; color: white; font-size: 11px; padding: 4px 8px;">
                                    <i class="fas fa-chart-bar"></i> 휴가 보고서
                                </a>
                                <a href="{{ url_for('admin.set_hire_date', user_id=employee.id) }}" 
                                   class="gov-btn gov-btn-success" style="font-size: 11px; padding: 4px 8px;">
                                    <i class="fas fa-calendar"></i> 입사일 설정
                                </a>
                                <button type="button" 
                                        onclick="confirmDeleteEmployee('{{ employee.id }}', '{{ employee.name }}')"
                                        class="gov-btn" style="background: #e74c3c; color: white; font-size: 11px; padding: 4px 8px;">
                                    <i class="fas fa-user-times"></i> 삭제
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="text-align: center; padding: 40px; color: #6c757d;">
                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <p style="font-size: 16px; margin: 0;">등록된 직원이 없습니다.</p>
                <p style="font-size: 14px; margin-top: 5px;">엑셀 파일로 직원을 등록해보세요.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- 연도별 조회 -->
<div class="gov-card" style="margin-top: 25px;">
    <div class="gov-card-header">
        <i class="fas fa-calendar-alt"></i> 연도별 조회
    </div>
    <div class="gov-card-body">
        <div style="display: flex; align-items: center; gap: 15px;">
            <label class="gov-form-label" style="margin: 0;">조회 연도:</label>
            <select id="yearSelect" class="gov-form-control" style="width: 120px;">
                {% for year in range(current_year - 3, current_year + 2) %}
                    <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}년</option>
                {% endfor %}
            </select>
            <button onclick="changeYear()" class="gov-btn gov-btn-primary">
                <i class="fas fa-search"></i> 조회
            </button>
        </div>
    </div>
</div>

<script>
    function changeYear() {
        const year = document.getElementById('yearSelect').value;
        window.location.href = "{{ url_for('admin.manage_employees') }}" + "?year=" + year;
    }

    function confirmDeleteEmployee(userId, userName) {
        if (confirm(`정말로 ${userName} 직원을 삭제하시겠습니까?\n관련된 모든 정보(휴가, 재직증명서 등)가 함께 삭제됩니다.\n이 작업은 되돌릴 수 없습니다.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('admin.delete_employee', user_id=0) }}".replace('0', userId);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}
